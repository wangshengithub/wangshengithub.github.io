const BUILDINGS={farm:{id:"farm",name:"Farm",category:"Food",effect:"Produces 1 food/s",type:"producer",produces:"food",baseProduction:1,costs:{food:10},costScaling:1.2,icon:"üåæ"},irrigationStation:{id:"irrigationStation",name:"Irrigation Station",category:"Food",effect:"Multiplies Farm production",type:"multiplier",multiplies:"food",multiplierGroup:1,multiplierBonus:1,costs:{food:100,wood:50},costScaling:1.3,icon:"üíß"},mill:{id:"mill",name:"Mill",category:"Food",effect:"Multiplies Farm production (+2x each)",type:"multiplier",multiplies:"food",multiplierGroup:2,multiplierBonus:2,costs:{food:1e3,wood:500,stone:200},costScaling:1.4,icon:"üè≠"},granary:{id:"granary",name:"Granary",category:"Food",effect:"Multiplies Farm production (+3x each)",type:"multiplier",multiplies:"food",multiplierGroup:3,multiplierBonus:3,costs:{food:1e4,wood:5e3,stone:2e3,metal:1e3},costScaling:1.5,icon:"üèõÔ∏è"},lumberCamp:{id:"lumberCamp",name:"Lumber Camp",category:"Wood",effect:"Produces 1 wood/s",type:"producer",produces:"wood",baseProduction:1,costs:{food:100},costScaling:1.3,icon:"ü™ì"},woodcuttersLodge:{id:"woodcuttersLodge",name:"Woodcutter's Lodge",category:"Wood",effect:"Multiplies Lumber Camp production (+1x each)",type:"multiplier",multiplies:"wood",multiplierGroup:1,multiplierBonus:1,costs:{food:400,wood:200},costScaling:1.4,icon:"üè†"},sawmill:{id:"sawmill",name:"Sawmill",category:"Wood",effect:"Multiplies Lumber Camp production (+2x each)",type:"multiplier",multiplies:"wood",multiplierGroup:2,multiplierBonus:2,costs:{food:1600,wood:800,stone:400},costScaling:1.5,icon:"ü™ö"},timberYard:{id:"timberYard",name:"Timber Yard",category:"Wood",effect:"Multiplies Lumber Camp production (+3x each)",type:"multiplier",multiplies:"wood",multiplierGroup:3,multiplierBonus:3,costs:{food:6400,wood:3200,stone:1600,metal:800},costScaling:1.6,icon:"üèóÔ∏è"},quarry:{id:"quarry",name:"Quarry",category:"Stone",effect:"Produces 1 stone/s",type:"producer",produces:"stone",baseProduction:1,costs:{food:400,wood:200},costScaling:1.4,icon:"‚õèÔ∏è"},stonecuttersShed:{id:"stonecuttersShed",name:"Stonecutter's Shed",category:"Stone",effect:"Multiplies Quarry production (+1x each)",type:"multiplier",multiplies:"stone",multiplierGroup:1,multiplierBonus:1,costs:{food:1600,wood:800,stone:400},costScaling:1.5,icon:"üî®"},masonsWorkshop:{id:"masonsWorkshop",name:"Mason's Workshop",category:"Stone",effect:"Multiplies Quarry production (+2x each)",type:"multiplier",multiplies:"stone",multiplierGroup:2,multiplierBonus:2,costs:{food:6400,wood:3200,stone:1600,metal:800},costScaling:1.6,icon:"üß±"},kiln:{id:"kiln",name:"Kiln",category:"Stone",effect:"Multiplies Quarry production (+3x each)",type:"multiplier",multiplies:"stone",multiplierGroup:3,multiplierBonus:3,costs:{food:25600,wood:12800,stone:6400,metal:3200},costScaling:1.7,icon:"üî•"},mine:{id:"mine",name:"Mine",category:"Metal",effect:"Produces 1 metal/s",type:"producer",produces:"metal",baseProduction:1,costs:{food:1600,wood:800,stone:400},costScaling:1.5,icon:"‚öíÔ∏è"},orePurifier:{id:"orePurifier",name:"Ore Purifier",category:"Metal",effect:"Multiplies Mine production (+1x each)",type:"multiplier",multiplies:"metal",multiplierGroup:1,multiplierBonus:1,costs:{food:6400,wood:3200,stone:1600,metal:800},costScaling:1.6,icon:"üß™"},smelter:{id:"smelter",name:"Smelter",category:"Metal",effect:"Multiplies Mine production (+2x each)",type:"multiplier",multiplies:"metal",multiplierGroup:2,multiplierBonus:2,costs:{food:25600,wood:12800,stone:6400,metal:3200},costScaling:1.7,icon:"üåã"},foundry:{id:"foundry",name:"Foundry",category:"Metal",effect:"Multiplies Mine production (+3x each)",type:"multiplier",multiplies:"metal",multiplierGroup:3,multiplierBonus:3,costs:{food:102400,wood:51200,stone:25600,metal:12800},costScaling:1.8,icon:"‚öôÔ∏è"},beacon:{id:"beacon",name:"Beacon",category:"Beacons",effect:"Multiplies adjacent production 2x",type:"beacon",beaconMultiplier:2,costs:{food:25e3,wood:25e3,stone:25e3,metal:25e3},costScaling:8,icon:"üî¶"},scribeHouse:{id:"scribeHouse",name:"Scribe House",category:"Research",effect:"Produces 1 research/s",type:"producer",produces:"research",baseProduction:1,costs:{food:8e3,wood:4e3,stone:2e3},costScaling:3,icon:"üìú"},library:{id:"library",name:"Library",category:"Research",effect:"Multiplies research production (+1x each)",type:"multiplier",multiplies:"research",multiplierGroup:1,multiplierBonus:1,costs:{food:32e3,wood:16e3,stone:8e3,metal:4e3},costScaling:3,icon:"üìö"},scholarTower:{id:"scholarTower",name:"Scholar Tower",category:"Research",effect:"Multiplies research production (+2x each)",type:"multiplier",multiplies:"research",multiplierGroup:2,multiplierBonus:2,costs:{food:128e3,wood:64e3,stone:32e3,metal:16e3},costScaling:3,icon:"üóº"},greatHallOfLearning:{id:"greatHallOfLearning",name:"Great Hall of Learning",category:"Research",effect:"Multiplies research production (+3x each)",type:"multiplier",multiplies:"research",multiplierGroup:3,multiplierBonus:3,costs:{food:512e3,wood:256e3,stone:128e3,metal:64e3},costScaling:3,icon:"üè∞"},tileFood:{id:"tileFood",name:"Buy Tile (Food)",category:"Tiles",effect:"Grants you an extra tile",type:"tile",costs:{food:100},costScaling:10,icon:"üü©"},tileWood:{id:"tileWood",name:"Buy Tile (Wood)",category:"Tiles",effect:"Grants you an extra tile",type:"tile",costs:{wood:100},costScaling:10,icon:"üü´"},tileStone:{id:"tileStone",name:"Buy Tile (Stone)",category:"Tiles",effect:"Grants you an extra tile",type:"tile",costs:{stone:100},costScaling:10,icon:"‚¨ú"},tileMetal:{id:"tileMetal",name:"Buy Tile (Metal)",category:"Tiles",effect:"Grants you an extra tile",type:"tile",costs:{metal:100},costScaling:10,icon:"üü¶"},magiciansGuild:{id:"magiciansGuild",name:"Magician's Guild",category:"Mana",effect:"Produces 1 mana/s",type:"producer",produces:"mana",baseProduction:1,costs:{food:4e3,wood:2e3,stone:1e3},costScaling:2,icon:"üîÆ"},arcaneArchive:{id:"arcaneArchive",name:"Arcane Archive",category:"Mana",effect:"Multiplies Magician's Guild production (+1x each)",type:"multiplier",multiplies:"mana",multiplierGroup:1,multiplierBonus:1,costs:{food:16e3,wood:8e3,stone:4e3,metal:2e3},costScaling:2,icon:"üìñ"},glyphWorkshop:{id:"glyphWorkshop",name:"Glyph Workshop",category:"Mana",effect:"Multiplies Magician's Guild production (+2x each)",type:"multiplier",multiplies:"mana",multiplierGroup:2,multiplierBonus:2,costs:{food:64e3,wood:32e3,stone:16e3,metal:8e3},costScaling:2,icon:"‚ú¥Ô∏è"},grandAcademyOfMagic:{id:"grandAcademyOfMagic",name:"Grand Academy of Magic",category:"Mana",effect:"Multiplies Magician's Guild production (+3x each)",type:"multiplier",multiplies:"mana",multiplierGroup:3,multiplierBonus:3,costs:{food:256e3,wood:128e3,stone:64e3,metal:32e3},costScaling:2,icon:"üèØ"}};function getBuildingsByCategory(e){return Object.values(BUILDINGS).filter(t=>t.category===e)}function getCategories(){return[...new Set(Object.values(BUILDINGS).map(e=>e.category))]}const RESOURCE_ICONS={food:"üåæ",wood:"ü™µ",stone:"ü™®",metal:"‚öôÔ∏è",research:"üìö",mana:"‚ú®"};window.BUILDINGS=BUILDINGS,window.getBuildingsByCategory=getBuildingsByCategory,window.getCategories=getCategories,window.RESOURCE_ICONS=RESOURCE_ICONS;const SKILLS={sizeMatters:{id:"sizeMatters",name:"Size Matters",description:"1.02x basic resource production per tile owned (per level)",icon:"üìê",baseCost:2,costPerLevel:2,maxLevel:5,requires:["productionBoost"],effect:{productionPerTile:.02},position:{row:0,col:1}},manaProduction:{id:"manaProduction",name:"Mana Production",description:"+50% mana production per level",icon:"üîÆ",baseCost:2,costPerLevel:2,maxLevel:5,requires:["unlockMana"],effect:{manaProductionPerLevel:.5},position:{row:3,col:0}},researchProduction:{id:"researchProduction",name:"Research Production",description:"+50% research production per level",icon:"üìö",baseCost:2,costPerLevel:2,maxLevel:5,requires:["unlockResearch"],effect:{researchProductionPerLevel:.5},position:{row:3,col:2}},productionBoost:{id:"productionBoost",name:"Efficient Production",description:"+25% basic resource production per level",icon:"‚ö°",baseCost:1,costPerLevel:0,maxLevel:12,requires:[],effect:{basicProductionPerLevel:.25},position:{row:1,col:1}},unlockMana:{id:"unlockMana",name:"Arcane Knowledge",description:"Unlock Mana buildings",icon:"‚ú®",baseCost:2,costPerLevel:0,maxLevel:1,requires:["productionBoost"],effect:{unlockCategory:"Mana"},position:{row:2,col:0}},unlockBeacons:{id:"unlockBeacons",name:"Beacon Mastery",description:"Unlock Beacons (2x boost to 8 adjacent tiles)",icon:"üí°",baseCost:5,costPerLevel:0,maxLevel:1,requires:["productionBoost"],effect:{unlockCategory:"Beacons"},position:{row:2,col:1}},unlockResearch:{id:"unlockResearch",name:"Scientific Method",description:"Unlock Research buildings",icon:"üî¨",baseCost:3,costPerLevel:0,maxLevel:1,requires:["productionBoost"],effect:{unlockCategory:"Research"},position:{row:2,col:2}}};function getSkillCost(e,t){const s=SKILLS[e];return s?s.baseCost+t*s.costPerLevel:1/0}const BASIC_RESOURCES=["food","wood","stone","metal"];function calculateSkillEffects(e){const t={globalProductionMultiplier:1,unlockedCategories:new Set(["Food","Wood","Stone","Metal","Tiles"]),productionBonus:{food:0,wood:0,stone:0,metal:0,research:0,mana:0},startingResources:{food:0,wood:0,stone:0,metal:0,research:0,mana:0},startingTiles:0,costReduction:0,tileCostReduction:0,productionPerLevel:0,basicProductionPerLevel:0,manaProductionPerLevel:0,researchProductionPerLevel:0,productionPerTile:0};for(const[s,i]of Object.entries(e)){if(!i||i<=0)continue;const e=SKILLS[s];if(!e)continue;const n=e.effect;if(n.globalProductionMultiplier&&(t.globalProductionMultiplier*=n.globalProductionMultiplier),n.unlockCategory&&t.unlockedCategories.add(n.unlockCategory),n.productionBonus)for(const e in n.productionBonus)t.productionBonus[e]+=n.productionBonus[e];if(n.startingResources)for(const e in n.startingResources)t.startingResources[e]+=n.startingResources[e];n.startingTiles&&(t.startingTiles+=n.startingTiles),n.costReduction&&(t.costReduction+=n.costReduction),n.tileCostReduction&&(t.tileCostReduction+=n.tileCostReduction),n.productionPerLevel&&(t.productionPerLevel+=n.productionPerLevel*i),n.basicProductionPerLevel&&(t.basicProductionPerLevel+=n.basicProductionPerLevel*i),n.manaProductionPerLevel&&(t.manaProductionPerLevel+=n.manaProductionPerLevel*i),n.researchProductionPerLevel&&(t.researchProductionPerLevel+=n.researchProductionPerLevel*i),n.productionPerTile&&(t.productionPerTile+=n.productionPerTile*i)}return t}function canPurchaseSkill(e,t){const s=SKILLS[e];if(!s)return!1;const i=t[e]||0;if(null!==s.maxLevel&&i>=s.maxLevel)return!1;for(const e of s.requires)if(!t[e]||t[e]<=0)return!1;return!0}function isSkillAvailable(e,t){return canPurchaseSkill(e,t)}function isSkillLocked(e,t){const s=SKILLS[e];if(!s)return!0;for(const e of s.requires)if(!t[e]||t[e]<=0)return!0;return!1}function isSkillMaxed(e,t){const s=SKILLS[e];if(!s)return!1;const i=t[e]||0;return null!==s.maxLevel&&i>=s.maxLevel}function getSkillTree(){const e={};for(const[t,s]of Object.entries(SKILLS)){const i=s.position.row;e[i]||(e[i]=[]),e[i].push({...s,id:t})}for(const t in e)e[t].sort((e,t)=>e.position.col-t.position.col);return e}function isCategoryUnlocked(e,t){return calculateSkillEffects(t).unlockedCategories.has(e)}window.SKILLS=SKILLS,window.BASIC_RESOURCES=BASIC_RESOURCES,window.getSkillCost=getSkillCost,window.calculateSkillEffects=calculateSkillEffects,window.canPurchaseSkill=canPurchaseSkill,window.isSkillAvailable=isSkillAvailable,window.isSkillLocked=isSkillLocked,window.isSkillMaxed=isSkillMaxed,window.getSkillTree=getSkillTree,window.isCategoryUnlocked=isCategoryUnlocked;const RESEARCH={foodProduction:{id:"foodProduction",name:"Agricultural Studies",description:"Increases food production",icon:"üåæ",effectPerLevel:.2,effectType:"productionMultiplier",resource:"food",baseCost:500,costScaling:1.5,maxLevel:null},woodProduction:{id:"woodProduction",name:"Forestry Research",description:"Increases wood production",icon:"ü™µ",effectPerLevel:.2,effectType:"productionMultiplier",resource:"wood",baseCost:1500,costScaling:1.5,maxLevel:null},stoneProduction:{id:"stoneProduction",name:"Geology Studies",description:"Increases stone production",icon:"ü™®",effectPerLevel:.2,effectType:"productionMultiplier",resource:"stone",baseCost:4e3,costScaling:1.5,maxLevel:null},metalProduction:{id:"metalProduction",name:"Metallurgy",description:"Increases metal production",icon:"‚öôÔ∏è",effectPerLevel:.2,effectType:"productionMultiplier",resource:"metal",baseCost:1e4,costScaling:1.5,maxLevel:null},beaconStrength:{id:"beaconStrength",name:"Beacon Amplification",description:"Increases beacon multiplier",icon:"üî¶",effectPerLevel:.1,effectType:"beaconBonus",baseCost:25e3,costScaling:2,maxLevel:null},spaceProgram:{id:"spaceProgram",name:"Space Program",description:"Unlocks space exploration",icon:"üöÄ",effectType:"unlock",unlocks:"space",baseCost:1e7,costScaling:1,maxLevel:1}};function getResearchCost(e,t){const s=RESEARCH[e];return s?Math.floor(s.baseCost*Math.pow(s.costScaling,t)):1/0}function getResearchEffect(e,t){const s=RESEARCH[e];return!s||t<=0?0:s.effectPerLevel*t}function getResearchProductionMultiplier(e,t){for(const s in RESEARCH){const i=RESEARCH[s];if("productionMultiplier"===i.effectType&&i.resource===e){return 1+getResearchEffect(s,t[s]||0)}}return 1}function getResearchBeaconBonus(e){return getResearchEffect("beaconStrength",e.beaconStrength||0)}function isSpaceUnlocked(e){return(e.spaceProgram||0)>=1}window.RESEARCH=RESEARCH,window.getResearchCost=getResearchCost,window.getResearchEffect=getResearchEffect,window.getResearchProductionMultiplier=getResearchProductionMultiplier,window.getResearchBeaconBonus=getResearchBeaconBonus,window.isSpaceUnlocked=isSpaceUnlocked;const Game={CONSTANTS:{SAVE_VERSION:3,TICK_RATE_MS:100,AUTO_SAVE_INTERVAL_MS:5e3,MAX_OFFLINE_SECONDS:86400,TIME_WARP_BASE_MANA_PER_SECOND:10,TIME_WARP_TIER_SECONDS:3600,TIME_WARP_MIN_MANA:10,BLESS_TILE_BASE_COST:1e3,BLESS_TILE_COST_MULTIPLIER:2,BLESS_TILE_MAX_COST_EXPONENT:50,BLESSING_MULTIPLIER:3,STARTING_FOOD:10,MISSILE_SILO_COST:1e8,ROCKET_LAUNCH_COST:25e7},state:{resources:{food:0,wood:0,stone:0,metal:0,research:0,mana:0},buildingCounts:{},tilePurchases:{tileFood:0,tileWood:0,tileStone:0,tileMetal:0},blessedTiles:{},blessingsCast:0,timeWarpSecondsSkipped:0,grid:{},gridBounds:{minX:0,maxX:2,minY:0,maxY:2},selectedTile:null,selectedBuilding:null,lastTick:Date.now(),hasMissileSilo:!1,hasLaunchedRocket:!1,currentView:"earth",spaceGrid:{},spaceGridBounds:{minX:0,maxX:2,minY:0,maxY:2},spaceBuildingCounts:{},spaceTilePurchases:{tileFood:0,tileWood:0,tileStone:0,tileMetal:0},spaceBlessedTiles:{}},prestige:{lifetimeResources:0,skillPoints:0,pendingSkillPoints:0,skills:{},tutorialShown:!1},research:{levels:{}},skillPointBase:1e3,skillPointMultiplier:2,productionRates:{food:0,wood:0,stone:0,metal:0,research:0,mana:0},init(){this.loadGame()&&0!==Object.keys(this.state.grid).length||(this.state.resources.food=this.CONSTANTS.STARTING_FOOD,this.initializeDefaultGrid()),this.calculateProductionRates(),this.startGameLoop()},initializeDefaultGrid(){for(let e=0;e<=2;e++)for(let t=0;t<=2;t++)this.state.grid[`${e},${t}`]={owned:!0,building:null}},startGameLoop(){setInterval(()=>{const e=Date.now(),t=(e-this.state.lastTick)/1e3;this.state.lastTick=e,this.tick(t)},this.CONSTANTS.TICK_RATE_MS),setInterval(()=>{this.saveGame()},this.CONSTANTS.AUTO_SAVE_INTERVAL_MS)},tick(e){this.calculateProductionRates();let t=0;for(const s in this.productionRates){const i=this.productionRates[s]*e;this.state.resources[s]+=i,t+=i}if(t>0){const e=this.prestige.lifetimeResources;this.prestige.lifetimeResources+=t,this.updatePendingSkillPoints(e)}window.UI&&(UI.updateResourceDisplay(),UI.updateSkillPointDisplay())},calculateTotalSkillPoints(e){return e<this.skillPointBase?0:Math.floor(Math.log(e/this.skillPointBase)/Math.log(this.skillPointMultiplier))+1},getNextSkillPointThreshold(){const e=this.calculateTotalSkillPoints(this.prestige.lifetimeResources);return this.skillPointBase*Math.pow(this.skillPointMultiplier,e)},getSkillPointProgress(){const e=this.prestige.lifetimeResources,t=this.calculateTotalSkillPoints(e),s=0===t?0:this.skillPointBase*Math.pow(this.skillPointMultiplier,t-1),i=this.skillPointBase*Math.pow(this.skillPointMultiplier,t);return e<this.skillPointBase?e/this.skillPointBase:(e-s)/(i-s)},updatePendingSkillPoints(e){const t=this.prestige.pendingSkillPoints,s=this.calculateTotalSkillPoints(this.prestige.lifetimeResources);let i=0;if(window.SKILLS&&window.getSkillCost)for(const[e,t]of Object.entries(this.prestige.skills))if(t&&t>0&&SKILLS[e])for(let s=0;s<t;s++)i+=getSkillCost(e,s);const n=this.prestige.skillPoints+i;this.prestige.pendingSkillPoints=Math.max(0,s-n),0===t&&this.prestige.pendingSkillPoints>=1&&!this.prestige.tutorialShown&&(this.prestige.tutorialShown=!0,this.saveGame(),window.UI&&UI.showSPTutorial&&UI.showSPTutorial())},calculateProductionRates(){for(const e in this.productionRates)this.productionRates[e]=0;const e={food:0,wood:0,stone:0,metal:0,research:0,mana:0};for(const[t,s]of Object.entries(this.state.grid)){if(!s.owned||!s.building)continue;const i=window.BUILDINGS?BUILDINGS[s.building]:null;if(i&&"producer"===i.type){const n="mana"===i.produces||"research"===i.produces?1:this.getBeaconMultiplier(t),o=this.getBlessingMultiplier(t,s.building),a=i.baseProduction*n*o;e[i.produces]+=a}}for(const t in e)this.productionRates[t]=e[t]*this.getResourceMultiplier(t)},calculateGlobalMultipliers(){const e={food:1,wood:1,stone:1,metal:1,research:1,mana:1},t={};for(const[e,s]of Object.entries(this.state.grid)){if(!s.owned||!s.building)continue;const i=window.BUILDINGS?BUILDINGS[s.building]:null;if(!i||"multiplier"!==i.type)continue;const n=i.multiplies;t[n]||(t[n]={}),t[n][i.multiplierGroup]||(t[n][i.multiplierGroup]=1);const o=i.multiplierBonus||1,a=this.getBlessingMultiplier(e,s.building),l="mana"===n||"research"===n?1:this.getBeaconMultiplier(e);t[n][i.multiplierGroup]+=o*a*l}for(const s in t){let i=1;for(const e in t[s])i*=t[s][e];e[s]=i}return e},getBeaconMultiplier(e){const[t,s]=e.split(",").map(Number);let i=1;const n=this.getResearchBeaconBonus(),o=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];for(const[e,a]of o){const o=`${t+e},${s+a}`,l=this.state.grid[o];if(l&&l.owned&&l.building){const e=window.BUILDINGS?BUILDINGS[l.building]:null;e&&"beacon"===e.type&&(i*=e.beaconMultiplier+n)}}return i},getBuildingCost(e){const t=window.BUILDINGS?BUILDINGS[e]:null;if(!t)return{};const s="space"===this.state.currentView,i=s?this.state.spaceTilePurchases:this.state.tilePurchases,n=s?this.state.spaceBuildingCounts:this.state.buildingCounts,o="tile"===t.type?i[e]||0:n[e]||0,a=this.getSkillEffects()||{costReduction:0,tileCostReduction:0},l="tile"===t.type?a.tileCostReduction||0:a.costReduction||0,r=Math.max(.1,1-l),c={};for(const[e,s]of Object.entries(t.costs))c[e]=Math.floor(s*Math.pow(t.costScaling,o)*r);return c},canAfford(e){const t=this.getBuildingCost(e);for(const[e,s]of Object.entries(t))if(this.state.resources[e]<s)return!1;return!0},spendResources(e){const t=this.getBuildingCost(e);for(const[e,s]of Object.entries(t))this.state.resources[e]-=s},placeBuilding(e,t){const s="space"===this.state.currentView?this.state.spaceGrid:this.state.grid,i="space"===this.state.currentView?this.state.spaceBuildingCounts:this.state.buildingCounts,n=s[e];return(window.BUILDINGS?BUILDINGS[t]:null)?n&&n.owned?n.building?(console.log("Tile already has a building"),!1):this.canAfford(t)?(this.spendResources(t),n.building=t,i[t]=(i[t]||0)+1,this.saveGame(),!0):(console.log("Cannot afford building"),!1):(console.log("Tile not owned"),!1):(console.log("Invalid building type"),!1)},purchaseTile(e,t){const s="space"===this.state.currentView,i=s?this.state.spaceGrid:this.state.grid,n=s?this.state.spaceTilePurchases:this.state.tilePurchases,o=s?this.state.spaceGridBounds:this.state.gridBounds,a=window.BUILDINGS?BUILDINGS[t]:null;if(!a||"tile"!==a.type)return console.log("Invalid tile purchase type"),!1;if(!this.canAfford(t))return console.log("Cannot afford tile"),!1;if(!this.isAdjacentToOwnedInGrid(e,i))return console.log("Tile must be adjacent to owned tile"),!1;if(i[e]&&i[e].owned)return console.log("Tile already owned"),!1;this.spendResources(t),n[t]++,i[e]={owned:!0,building:null};const[l,r]=e.split(",").map(Number);return o.minX=Math.min(o.minX,l),o.maxX=Math.max(o.maxX,l),o.minY=Math.min(o.minY,r),o.maxY=Math.max(o.maxY,r),this.saveGame(),!0},isAdjacentToOwned(e){return this.isAdjacentToOwnedInGrid(e,this.state.grid)},isAdjacentToOwnedInGrid(e,t){const[s,i]=e.split(",").map(Number),n=[[0,-1],[0,1],[-1,0],[1,0]];for(const[e,o]of n){const n=t[`${s+e},${i+o}`];if(n&&n.owned)return!0}return!1},getExpandableTiles(){const e=new Set;for(const[t,s]of Object.entries(this.state.grid)){if(!s.owned)continue;const[i,n]=t.split(",").map(Number),o=[[0,-1],[0,1],[-1,0],[1,0]];for(const[t,s]of o){const o=`${i+t},${n+s}`,a=this.state.grid[o];a&&a.owned||e.add(o)}}return e},removeBuilding(e){const t=this.state.grid[e];if(!t||!t.building)return!1;const s=t.building;return this.state.buildingCounts[s]--,t.building=null,this.saveGame(),!0},getSaveData(){return{saveVersion:this.CONSTANTS.SAVE_VERSION,resources:this.state.resources,buildingCounts:this.state.buildingCounts,tilePurchases:this.state.tilePurchases,blessedTiles:this.state.blessedTiles,blessingsCast:this.state.blessingsCast,timeWarpSecondsSkipped:this.state.timeWarpSecondsSkipped,grid:this.state.grid,gridBounds:this.state.gridBounds,hasMissileSilo:this.state.hasMissileSilo,hasLaunchedRocket:this.state.hasLaunchedRocket,currentView:this.state.currentView,spaceGrid:this.state.spaceGrid,spaceGridBounds:this.state.spaceGridBounds,spaceBuildingCounts:this.state.spaceBuildingCounts,spaceTilePurchases:this.state.spaceTilePurchases,spaceBlessedTiles:this.state.spaceBlessedTiles,prestige:this.prestige,research:this.research,savedAt:Date.now()}},saveGame(){localStorage.setItem("tileEmpireSave",JSON.stringify(this.getSaveData()))},exportSave(){const e=JSON.stringify(this.getSaveData());return btoa(encodeURIComponent(e))},validateAndMigrateSave(e){e.saveVersion||(e.saveVersion=0),e.saveVersion<2&&(e.timeWarpSecondsSkipped=0),e.saveVersion<3&&(e.hasMissileSilo=!1,e.hasLaunchedRocket=!1,e.currentView="earth",e.spaceGrid={},e.spaceGridBounds={minX:0,maxX:2,minY:0,maxY:2},e.spaceBuildingCounts={},e.spaceTilePurchases={tileFood:0,tileWood:0,tileStone:0,tileMetal:0},e.spaceBlessedTiles={});const t=["food","wood","stone","metal","research","mana"];if(e.resources)for(const s of t)"number"!=typeof e.resources[s]&&(e.resources[s]=0);const s=["tileFood","tileWood","tileStone","tileMetal"];if(e.tilePurchases)for(const t of s)"number"!=typeof e.tilePurchases[t]&&(e.tilePurchases[t]=0);return e},importSave(e){try{const t=decodeURIComponent(atob(e));let s=JSON.parse(t);return!(!s.grid||!s.resources)&&(s=this.validateAndMigrateSave(s),this.state.resources=s.resources||this.state.resources,this.state.buildingCounts=s.buildingCounts||{},this.state.tilePurchases=s.tilePurchases||this.state.tilePurchases,this.state.blessedTiles=s.blessedTiles||{},this.state.blessingsCast=s.blessingsCast||0,this.state.timeWarpSecondsSkipped=s.timeWarpSecondsSkipped||0,this.state.grid=s.grid||{},this.state.gridBounds=s.gridBounds||this.state.gridBounds,this.state.hasMissileSilo=s.hasMissileSilo||!1,this.state.hasLaunchedRocket=s.hasLaunchedRocket||!1,this.state.currentView=s.currentView||"earth",this.state.spaceGrid=s.spaceGrid||{},this.state.spaceGridBounds=s.spaceGridBounds||{minX:0,maxX:2,minY:0,maxY:2},this.state.spaceBuildingCounts=s.spaceBuildingCounts||{},this.state.spaceTilePurchases=s.spaceTilePurchases||{tileFood:0,tileWood:0,tileStone:0,tileMetal:0},this.state.spaceBlessedTiles=s.spaceBlessedTiles||{},s.prestige&&(this.prestige={...this.prestige,...s.prestige}),s.research&&(this.research={...this.research,...s.research}),this.updatePendingSkillPoints(0),this.saveGame(),!0)}catch(e){return console.error("Failed to import save:",e),!1}},loadGame(){const e=localStorage.getItem("tileEmpireSave");if(!e)return!1;try{let t=JSON.parse(e);if(t=this.validateAndMigrateSave(t),this.state.resources=t.resources||this.state.resources,this.state.buildingCounts=t.buildingCounts||{},this.state.tilePurchases=t.tilePurchases||this.state.tilePurchases,this.state.blessedTiles=t.blessedTiles||{},this.state.blessingsCast=t.blessingsCast||0,this.state.timeWarpSecondsSkipped=t.timeWarpSecondsSkipped||0,this.state.grid=t.grid||{},this.state.gridBounds=t.gridBounds||this.state.gridBounds,this.state.hasMissileSilo=t.hasMissileSilo||!1,this.state.hasLaunchedRocket=t.hasLaunchedRocket||!1,this.state.currentView=t.currentView||"earth",this.state.spaceGrid=t.spaceGrid||{},this.state.spaceGridBounds=t.spaceGridBounds||{minX:0,maxX:2,minY:0,maxY:2},this.state.spaceBuildingCounts=t.spaceBuildingCounts||{},this.state.spaceTilePurchases=t.spaceTilePurchases||{tileFood:0,tileWood:0,tileStone:0,tileMetal:0},this.state.spaceBlessedTiles=t.spaceBlessedTiles||{},t.prestige&&(this.prestige={...this.prestige,...t.prestige}),t.research&&(this.research={...this.research,...t.research}),this.updatePendingSkillPoints(0),t.savedAt){const e=(Date.now()-t.savedAt)/1e3;this.calculateOfflineProgress(e)}return!0}catch(e){return console.error("Failed to load save:",e),!1}},calculateOfflineProgress(e){e=Math.min(e,this.CONSTANTS.MAX_OFFLINE_SECONDS),this.calculateProductionRates();for(const t in this.productionRates)this.state.resources[t]+=this.productionRates[t]*e;e>60&&console.log(`Welcome back! You earned resources while away for ${Math.floor(e/60)} minutes.`)},prestigeReset(e=!1){if(!e){const e=this.prestige.pendingSkillPoints;if(0===e){if(!confirm("‰Ω†Ê≤°ÊúâÂæÖÈ¢ÜÂèñÁöÑÊäÄËÉΩÁÇπ„ÄÇÊÇ®Á°ÆÂÆöË¶ÅÈáçÁΩÆËøõÂ∫¶Âêó?"))return!1}else if(!confirm(`ÈáçÁΩÆ‰Ω†ÁöÑÁΩëÊ†º‰ª•È¢ÜÂèñ ${e} ÊäÄËÉΩÁÇπÊï∞${e>1?"s":""}?`))return!1}const t=this.prestige.pendingSkillPoints;this.prestige.skillPoints+=t,this.prestige.pendingSkillPoints=0;const s=window.calculateSkillEffects?calculateSkillEffects(this.prestige.skills):{startingResources:{food:0},startingTiles:0};this.state.resources={food:this.CONSTANTS.STARTING_FOOD+(s.startingResources.food||0),wood:s.startingResources.wood||0,stone:s.startingResources.stone||0,metal:s.startingResources.metal||0,research:s.startingResources.research||0,mana:s.startingResources.mana||0},this.state.buildingCounts={},this.state.tilePurchases={tileFood:0,tileWood:0,tileStone:0,tileMetal:0},this.state.blessedTiles={},this.state.blessingsCast=0,this.state.timeWarpSecondsSkipped=0,this.state.grid={},this.state.gridBounds={minX:0,maxX:2,minY:0,maxY:2},this.state.hasMissileSilo=!1,this.state.hasLaunchedRocket=!1,this.state.currentView="earth",this.state.spaceGrid={},this.state.spaceGridBounds={minX:0,maxX:2,minY:0,maxY:2},this.state.spaceBuildingCounts={},this.state.spaceTilePurchases={tileFood:0,tileWood:0,tileStone:0,tileMetal:0},this.state.spaceBlessedTiles={},this.initializeDefaultGrid();const i=s.startingTiles||0;return i>0&&this.addBonusStartingTiles(i),this.saveGame(),window.UI&&(UI.renderGrid(),UI.updateResourceDisplay(),UI.updateSkillPointDisplay(),UI.centerGrid()),!0},addBonusStartingTiles(e){const t=Array.from(this.getExpandableTiles());for(let s=0;s<e&&s<t.length;s++){const e=t[s];this.state.grid[e]={owned:!0,building:null};const[i,n]=e.split(",").map(Number);this.state.gridBounds.minX=Math.min(this.state.gridBounds.minX,i),this.state.gridBounds.maxX=Math.max(this.state.gridBounds.maxX,i),this.state.gridBounds.minY=Math.min(this.state.gridBounds.minY,n),this.state.gridBounds.maxY=Math.max(this.state.gridBounds.maxY,n)}},purchaseSkill(e){const t=window.SKILLS?SKILLS[e]:null;if(!t)return!1;const s=this.prestige.skills[e]||0;if(null!==t.maxLevel&&s>=t.maxLevel)return!1;if(window.canPurchaseSkill&&!canPurchaseSkill(e,this.prestige.skills))return!1;const i=window.getSkillCost?getSkillCost(e,s):t.baseCost;return!(this.prestige.skillPoints<i)&&(this.prestige.skillPoints-=i,this.prestige.skills[e]=s+1,this.saveGame(),!0)},getSkillEffects(){return window.calculateSkillEffects?calculateSkillEffects(this.prestige.skills):null},getResourceMultiplier(e){const t=this.calculateGlobalMultipliers(),s=this.getSkillEffects()||{productionBonus:{food:0,wood:0,stone:0,metal:0,research:0,mana:0},globalProductionMultiplier:1,productionPerLevel:0,basicProductionPerLevel:0,manaProductionPerLevel:0,researchProductionPerLevel:0,productionPerTile:0};let i=0;for(const[e,t]of Object.entries(this.state.grid))t.owned&&i++;const n=window.BASIC_RESOURCES||["food","wood","stone","metal"],o=t[e]||1,a=1+(s.productionBonus[e]||0),l=s.globalProductionMultiplier||1,r=this.getResearchMultiplier(e);let c=1+(s.productionPerLevel||0);n.includes(e)?c*=1+(s.basicProductionPerLevel||0):"mana"===e?c*=1+(s.manaProductionPerLevel||0):"research"===e&&(c*=1+(s.researchProductionPerLevel||0));return o*a*l*c*(s.productionPerTile>0&&n.includes(e)?Math.pow(1+s.productionPerTile,i):1)*r},calculateBuildingProduction(e,t=1){return"producer"!==e.type?0:e.baseProduction*t*this.getResourceMultiplier(e.produces)},getBlessTileCost(){const e=Math.min(this.state.blessingsCast,this.CONSTANTS.BLESS_TILE_MAX_COST_EXPONENT);return this.CONSTANTS.BLESS_TILE_BASE_COST*Math.pow(this.CONSTANTS.BLESS_TILE_COST_MULTIPLIER,e)},calculateTimeWarpSeconds(e,t){const s=this.CONSTANTS.TIME_WARP_TIER_SECONDS,i=this.CONSTANTS.TIME_WARP_BASE_MANA_PER_SECOND;let n=e,o=0,a=t;for(;n>0;){const e=Math.floor(a/s),t=i+e,l=(e+1)*s-a,r=Math.floor(n/t),c=Math.min(r,l);if(c<=0)break;o+=c,a+=c,n-=c*t}return o},getTimeWarpCurrentCost(){const e=Math.floor(this.state.timeWarpSecondsSkipped/this.CONSTANTS.TIME_WARP_TIER_SECONDS);return this.CONSTANTS.TIME_WARP_BASE_MANA_PER_SECOND+e},getTimeWarpPreview(){const e=this.state.resources.mana;return e<this.CONSTANTS.TIME_WARP_MIN_MANA?0:this.calculateTimeWarpSeconds(e,this.state.timeWarpSecondsSkipped)},castTimeWarp(){const e=this.state.resources.mana;if(e<this.CONSTANTS.TIME_WARP_MIN_MANA)return{success:!1,message:`Need at least ${this.CONSTANTS.TIME_WARP_MIN_MANA} mana`};const t=this.calculateTimeWarpSeconds(e,this.state.timeWarpSecondsSkipped);if(t<=0)return{success:!1,message:"Not enough mana to skip any time"};this.state.resources.mana=0,this.state.timeWarpSecondsSkipped+=t,this.calculateProductionRates();const s=this.productionRates.mana;this.productionRates.mana=0;let i=0;for(const e in this.productionRates){const s=this.productionRates[e]*t;this.state.resources[e]+=s,i+=s}if(this.productionRates.mana=s,i>0){const e=this.prestige.lifetimeResources;this.prestige.lifetimeResources+=i,this.updatePendingSkillPoints(e)}return this.saveGame(),{success:!0,seconds:t}},castBlessTile(){const e=this.getBlessTileCost();if(this.state.resources.mana<e)return{success:!1,message:`Need ${Game.formatNumber(e)} mana`};const t=[];for(const[e,s]of Object.entries(this.state.grid))s.owned&&!s.building&&t.push(e);if(0===t.length)return{success:!1,message:"No empty tiles available"};const s=new Set;for(const[e,t]of Object.entries(this.state.grid))if(t.owned&&t.building){const e=window.BUILDINGS?BUILDINGS[t.building]:null;e&&"tile"!==e.type&&"beacon"!==e.type&&s.add(t.building)}if(0===s.size)return{success:!1,message:"No buildings on grid yet"};this.state.resources.mana-=e;const i=t[Math.floor(Math.random()*t.length)],n=Array.from(s),o=n[Math.floor(Math.random()*n.length)];this.state.blessedTiles[i]={buildingId:o,multiplier:this.CONSTANTS.BLESSING_MULTIPLIER},this.state.blessingsCast++,this.saveGame();const a=window.BUILDINGS?BUILDINGS[o]:null;return{success:!0,tile:i,buildingId:o,buildingName:a?a.name:"Unknown",buildingIcon:a?a.icon:"?"}},getTileBlessing(e){return this.state.blessedTiles[e]||null},getBlessingMultiplier(e,t){const s=this.state.blessedTiles[e];return s&&s.buildingId===t?s.multiplier:1},isManaUnlocked(){return this.prestige.skills.unlockMana>0},isResearchUnlocked(){return this.prestige.skills.unlockResearch>0},getResearchLevel(e){return this.research.levels[e]||0},purchaseResearch(e){if(!window.RESEARCH)return!1;const t=RESEARCH[e];if(!t)return!1;const s=this.getResearchLevel(e);if(null!==t.maxLevel&&s>=t.maxLevel)return!1;const i=window.getResearchCost?getResearchCost(e,s):t.baseCost;return!(this.state.resources.research<i)&&(this.state.resources.research-=i,this.research.levels[e]=s+1,this.saveGame(),!0)},getResearchMultiplier(e){return!this.prestige.skills.unlockResearch||this.prestige.skills.unlockResearch<=0?1:window.getResearchProductionMultiplier?getResearchProductionMultiplier(e,this.research.levels):1},getResearchBeaconBonus(){return!this.prestige.skills.unlockResearch||this.prestige.skills.unlockResearch<=0?0:window.getResearchBeaconBonus?getResearchBeaconBonus(this.research.levels):0},prestigeResetWithRefund(){let e=0;if(window.SKILLS&&window.getSkillCost)for(const[t,s]of Object.entries(this.prestige.skills))if(s&&s>0&&SKILLS[t])for(let i=0;i<s;i++)e+=getSkillCost(t,i);return this.prestige.skillPoints+=e,this.prestige.skills={},this.prestigeReset(!0)},resetGame(){confirm("ÊÇ®Á°ÆÂÆöË¶ÅÁ°¨ÈáçÁΩÆÂêóÔºüËøôÂ∞ÜÊäπÂéªÊâÄÊúâËøõÂ∫¶ÔºåÂåÖÊã¨ÊäÄËÉΩÁÇπ!")&&(localStorage.removeItem("tileEmpireSave"),location.reload())},isSpaceResearchUnlocked(){return window.isSpaceUnlocked&&isSpaceUnlocked(this.research.levels)},getCurrentGrid(){return"space"===this.state.currentView?this.state.spaceGrid:this.state.grid},getCurrentGridBounds(){return"space"===this.state.currentView?this.state.spaceGridBounds:this.state.gridBounds},getCurrentBuildingCounts(){return"space"===this.state.currentView?this.state.spaceBuildingCounts:this.state.buildingCounts},getCurrentTilePurchases(){return"space"===this.state.currentView?this.state.spaceTilePurchases:this.state.tilePurchases},getCurrentBlessedTiles(){return"space"===this.state.currentView?this.state.spaceBlessedTiles:this.state.blessedTiles},canAffordMissileSilo(){const e=this.CONSTANTS.MISSILE_SILO_COST;return this.state.resources.food>=e&&this.state.resources.wood>=e&&this.state.resources.stone>=e&&this.state.resources.metal>=e},find2x2EmptyTiles(){for(const[e,t]of Object.entries(this.state.grid)){if(!t.owned)continue;const[s,i]=e.split(",").map(Number),n=[`${s},${i}`,`${s+1},${i}`,`${s},${i+1}`,`${s+1},${i+1}`];let o=!0;for(const e of n){const t=this.state.grid[e];if(!t||!t.owned||t.building){o=!1;break}}if(o)return n}return null},canBuildMissileSilo(){if(this.state.hasMissileSilo)return{can:!1,reason:"Already built"};if(!this.isSpaceResearchUnlocked())return{can:!1,reason:"Space Program not researched"};if(!this.canAffordMissileSilo())return{can:!1,reason:"Need 100M of each resource"};const e=this.find2x2EmptyTiles();return e?{can:!0,tiles:e}:{can:!1,reason:"Need 4 empty adjacent tiles (2x2)"}},buildMissileSilo(){const e=this.canBuildMissileSilo();if(!e.can)return{success:!1,message:e.reason};const t=this.CONSTANTS.MISSILE_SILO_COST;this.state.resources.food-=t,this.state.resources.wood-=t,this.state.resources.stone-=t,this.state.resources.metal-=t;for(const t of e.tiles)this.state.grid[t].building="missileSilo";return this.state.hasMissileSilo=!0,this.saveGame(),{success:!0,tiles:e.tiles}},canAffordRocketLaunch(){const e=this.CONSTANTS.ROCKET_LAUNCH_COST;return this.state.resources.food>=e&&this.state.resources.wood>=e&&this.state.resources.stone>=e&&this.state.resources.metal>=e},canLaunchRocket(){return this.state.hasMissileSilo?this.state.hasLaunchedRocket?{can:!1,reason:"Already launched"}:this.canAffordRocketLaunch()?{can:!0}:{can:!1,reason:"Need 250M of each resource"}:{can:!1,reason:"Need missile silo"}},launchRocket(){const e=this.canLaunchRocket();if(!e.can)return{success:!1,message:e.reason};const t=this.CONSTANTS.ROCKET_LAUNCH_COST;return this.state.resources.food-=t,this.state.resources.wood-=t,this.state.resources.stone-=t,this.state.resources.metal-=t,this.state.hasLaunchedRocket=!0,this.initializeSpaceGrid(),this.saveGame(),{success:!0}},initializeSpaceGrid(){for(let e=0;e<=2;e++)for(let t=0;t<=2;t++)this.state.spaceGrid[`${e},${t}`]={owned:!0,building:null};this.state.spaceGridBounds={minX:0,maxX:2,minY:0,maxY:2}},setCurrentView(e){"earth"!==e&&"space"!==e||("space"!==e||this.state.hasLaunchedRocket)&&(this.state.currentView=e,this.state.selectedTile=null,this.state.selectedBuilding=null,this.saveGame())},formatNumber:e=>e<1e3?Math.floor(e).toString():e<1e6?(e/1e3).toFixed(1)+"K":e<1e9?(e/1e6).toFixed(2)+"M":e<1e12?(e/1e9).toFixed(2)+"B":(e/1e12).toFixed(2)+"T",formatNumberDecimal:e=>e<1e3?e.toFixed(1):e<1e6?(e/1e3).toFixed(1)+"K":e<1e9?(e/1e6).toFixed(2)+"M":e<1e12?(e/1e9).toFixed(2)+"B":(e/1e12).toFixed(2)+"T",formatRate(e){return 0===e?"+0":e<.1?"+"+e.toFixed(2):e<10?"+"+e.toFixed(1):"+"+this.formatNumber(e)}};window.Game=Game;const UI={selectedTile:null,menuTargetTile:null,menuType:null,viewBox:{x:0,y:0,width:800,height:600},zoom:1,minZoom:.25,maxZoom:4,isPanning:!1,panStart:{x:0,y:0},isTouchPanning:!1,touchStartDistance:0,touchStartZoom:1,lastTouchCenter:{x:0,y:0},tileSize:50,tileGap:4,elements:{},displayValues:{food:0,wood:0,stone:0,metal:0,research:0,mana:0},animationSpeed:.15,allBuildingCategories:["Food","Wood","Stone","Metal","Beacons","Research","Mana"],tileCategories:["Tiles"],init(){this.cacheElements(),this.setupEventListeners(),this.initializeViewBox(),this.renderGrid(),this.initializeDisplayValues(),this.updateResourceDisplay(),this.updateSkillPointDisplay(),this.updateSpellContainer(),this.updateResearchContainer(),this.updateSpaceContainer(),this.startAnimationLoop()},initializeDisplayValues(){for(const e of["food","wood","stone","metal","research","mana"])this.displayValues[e]=Game.state.resources[e]},startAnimationLoop(){const e=()=>{this.animateDisplayValues(),requestAnimationFrame(e)};requestAnimationFrame(e)},animateDisplayValues(){let e=!1;for(const t of["food","wood","stone","metal","research","mana"]){const s=Game.state.resources[t],i=this.displayValues[t];if(Math.abs(s-i)>.01){const n=s-i,o=Math.min(this.animationSpeed+1e-4*Math.abs(n),.5);this.displayValues[t]=i+n*o,e=!0}else i!==s&&(this.displayValues[t]=s,e=!0)}e&&this.renderDisplayValues()},renderDisplayValues(){for(const e of["food","wood","stone","metal","research","mana"]){this.elements.resources[e].value.textContent=Game.formatNumber(this.displayValues[e])}},cacheElements(){this.elements={gridSection:document.getElementById("grid-section"),gridSvg:document.getElementById("grid-svg"),gridContainer:document.getElementById("grid-container"),buildingMenu:document.getElementById("building-menu"),buildingMenuContent:document.getElementById("building-menu-content"),tileInfo:document.getElementById("tile-info"),tooltip:document.getElementById("tooltip"),resourceBar:document.getElementById("resource-bar"),skillPointsAvailable:document.getElementById("skill-points-available"),skillPointsPending:document.getElementById("skill-points-pending"),skillProgressBar:document.getElementById("skill-progress-bar"),skillPointTimer:document.getElementById("skill-point-timer"),skillPanel:document.getElementById("skill-panel"),skillPanelOverlay:document.getElementById("skill-panel-overlay"),skillPanelContent:document.getElementById("skill-panel-content"),panelSkillPoints:document.getElementById("panel-skill-points"),btnPrestige:document.getElementById("btn-prestige"),spellContainer:document.getElementById("spell-container"),spellTimeWarp:document.getElementById("spell-time-warp"),spellBlessTile:document.getElementById("spell-bless-tile"),researchContainer:document.getElementById("research-container"),researchList:document.getElementById("research-list"),spaceContainer:document.getElementById("space-container"),spacePhaseSilo:document.getElementById("space-phase-silo"),spacePhaseLaunch:document.getElementById("space-phase-launch"),spacePhaseTabs:document.getElementById("space-phase-tabs"),btnBuildSilo:document.getElementById("btn-build-silo"),btnLaunchRocket:document.getElementById("btn-launch-rocket"),btnViewEarth:document.getElementById("btn-view-earth"),btnViewSpace:document.getElementById("btn-view-space"),currentViewName:document.getElementById("current-view-name")},this.elements.resources={};for(const e of["food","wood","stone","metal","research","mana"]){const t=document.getElementById(`resource-${e}`);this.elements.resources[e]={container:t,value:t.querySelector(".resource-value"),rate:t.querySelector(".resource-rate")}}},initializeViewBox(){const e=this.elements.gridSvg.getBoundingClientRect();this.viewBox.width=e.width,this.viewBox.height=e.height,this.fitGridToViewport(.7),this.centerGrid()},fitGridToViewport(e=.8){const t="space"===Game.state.currentView?Game.state.spaceGridBounds:Game.state.gridBounds,s=(t.maxX-t.minX+3)*(this.tileSize+this.tileGap),i=(t.maxY-t.minY+3)*(this.tileSize+this.tileGap),n=this.viewBox.width*e/s,o=this.viewBox.height*e/i,a=Math.min(n,o);this.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,a))},centerGrid(){const e="space"===Game.state.currentView?Game.state.spaceGridBounds:Game.state.gridBounds,t=(e.maxX-e.minX+3)*(this.tileSize+this.tileGap),s=(e.maxY-e.minY+3)*(this.tileSize+this.tileGap),i=(e.minX-1)*(this.tileSize+this.tileGap)+t/2,n=(e.minY-1)*(this.tileSize+this.tileGap)+s/2,o=this.viewBox.width/this.zoom,a=this.viewBox.height/this.zoom;this.viewBox.x=i-o/2,this.viewBox.y=n-a/2,this.updateViewBox()},updateViewBox(){const e=this.elements.gridSvg,t=this.viewBox.width/this.zoom,s=this.viewBox.height/this.zoom;e.setAttribute("viewBox",`${this.viewBox.x} ${this.viewBox.y} ${t} ${s}`)},setupEventListeners(){document.getElementById("btn-zoom-in").addEventListener("click",()=>this.adjustZoom(1.2)),document.getElementById("btn-zoom-out").addEventListener("click",()=>this.adjustZoom(.8)),this.elements.gridSection.addEventListener("wheel",e=>{e.preventDefault();const t=e.deltaY<0?1.1:.9;this.zoomAtPoint(t,e.clientX,e.clientY)},{passive:!1}),this.elements.gridSection.addEventListener("mousedown",e=>{0!==e.button||e.target.closest(".svg-tile")||(this.startPan(e),this.hideMenu())}),document.addEventListener("mousemove",e=>{this.isPanning&&this.doPan(e)}),document.addEventListener("mouseup",e=>{this.isPanning&&this.endPan(e)}),this.elements.gridSection.addEventListener("touchstart",e=>{1!==e.touches.length||e.target.closest(".svg-tile")?2===e.touches.length&&this.startPinchZoom(e):this.startTouchPan(e)},{passive:!1}),this.elements.gridSection.addEventListener("touchmove",e=>{1===e.touches.length&&this.isTouchPanning?(e.preventDefault(),this.doTouchPan(e)):2===e.touches.length&&(e.preventDefault(),this.doPinchZoom(e))},{passive:!1}),this.elements.gridSection.addEventListener("touchend",e=>{0===e.touches.length?this.endTouchPan():1===e.touches.length&&this.startTouchPan(e)},{passive:!0}),document.addEventListener("click",e=>{e.target.closest("#building-menu")||e.target.closest(".svg-tile")||e.target.closest("#grid-controls")||this.hideMenu()}),document.getElementById("btn-export").addEventListener("click",()=>{const e=Game.exportSave();navigator.clipboard.writeText(e).then(()=>{this.showNotification("Save copied to clipboard!")}).catch(()=>{prompt("Copy this save data:",e)})}),document.getElementById("btn-export-file").addEventListener("click",()=>{const e=Game.exportSave(),t=new Blob([e],{type:"text/plain"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=`tile-empire-save-${(new Date).toISOString().slice(0,10)}.txt`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s),this.showNotification("Save file downloaded!")}),document.getElementById("btn-import").addEventListener("click",()=>{const e=prompt("Paste your save data:");e&&e.trim()&&(Game.importSave(e.trim())?(this.renderGrid(),this.updateResourceDisplay(),this.updateSkillPointDisplay(),this.hideMenu(),this.showNotification("Save imported!")):this.showNotification("Invalid save data!"))}),document.getElementById("btn-reset").addEventListener("click",()=>Game.resetGame()),document.getElementById("btn-skills").addEventListener("click",()=>this.showSkillPanel()),document.getElementById("btn-close-skills").addEventListener("click",()=>this.hideSkillPanel()),document.getElementById("btn-prestige").addEventListener("click",()=>this.showPrestigeModal()),this.elements.skillPanelOverlay.addEventListener("click",()=>this.hideSkillPanel()),document.getElementById("btn-confirm-prestige").addEventListener("click",()=>{this.hidePrestigeModal(),Game.prestigeReset(!0)&&this.showNotification("Reset complete! Skill points claimed.")}),document.getElementById("btn-cancel-prestige").addEventListener("click",()=>this.hidePrestigeModal()),document.getElementById("prestige-overlay").addEventListener("click",()=>this.hidePrestigeModal()),document.getElementById("btn-refund-prestige").addEventListener("click",()=>{this.hidePrestigeModal(),Game.prestigeResetWithRefund()&&this.showNotification("Reset complete! All skill points refunded.")}),document.getElementById("btn-sp-tutorial-close").addEventListener("click",()=>this.hideSPTutorial()),document.getElementById("sp-tutorial-overlay").addEventListener("click",()=>this.hideSPTutorial()),this.elements.spellTimeWarp.addEventListener("click",()=>this.castSpell("timeWarp")),this.elements.spellBlessTile.addEventListener("click",()=>this.castSpell("blessTile")),this.elements.btnBuildSilo&&this.elements.btnBuildSilo.addEventListener("click",()=>this.buildMissileSilo()),this.elements.btnLaunchRocket&&this.elements.btnLaunchRocket.addEventListener("click",()=>this.launchRocket()),this.elements.btnViewEarth&&this.elements.btnViewEarth.addEventListener("click",()=>this.switchView("earth")),this.elements.btnViewSpace&&this.elements.btnViewSpace.addEventListener("click",()=>this.switchView("space")),document.addEventListener("keydown",e=>{"Escape"===e.key&&(this.hideMenu(),this.hideSkillPanel(),this.hidePrestigeModal(),this.hideSPTutorial())}),window.addEventListener("resize",()=>{const e=this.elements.gridSvg.getBoundingClientRect();this.viewBox.width=e.width,this.viewBox.height=e.height,this.updateViewBox(),this.hideMenu()})},startPan(e){this.isPanning=!0,this.panStart={x:e.clientX,y:e.clientY},this.elements.gridSection.classList.add("dragging")},doPan(e){if(!this.isPanning)return;const t=e.clientX-this.panStart.x,s=e.clientY-this.panStart.y,i=this.viewBox.width/this.zoom/this.elements.gridSvg.getBoundingClientRect().width;this.viewBox.x-=t*i,this.viewBox.y-=s*i,this.panStart={x:e.clientX,y:e.clientY},this.updateViewBox()},endPan(e){this.isPanning=!1,this.elements.gridSection.classList.remove("dragging")},startTouchPan(e){const t=e.touches[0];this.isTouchPanning=!0,this.lastTouchCenter={x:t.clientX,y:t.clientY},this.elements.gridSection.classList.add("dragging"),this.hideMenu()},doTouchPan(e){if(!this.isTouchPanning)return;const t=e.touches[0],s=t.clientX-this.lastTouchCenter.x,i=t.clientY-this.lastTouchCenter.y,n=this.viewBox.width/this.zoom/this.elements.gridSvg.getBoundingClientRect().width;this.viewBox.x-=s*n,this.viewBox.y-=i*n,this.lastTouchCenter={x:t.clientX,y:t.clientY},this.updateViewBox()},endTouchPan(){this.isTouchPanning=!1,this.elements.gridSection.classList.remove("dragging")},getTouchDistance(e){const t=e[0].clientX-e[1].clientX,s=e[0].clientY-e[1].clientY;return Math.sqrt(t*t+s*s)},getTouchCenter:e=>({x:(e[0].clientX+e[1].clientX)/2,y:(e[0].clientY+e[1].clientY)/2}),startPinchZoom(e){this.isTouchPanning=!1,this.touchStartDistance=this.getTouchDistance(e.touches),this.touchStartZoom=this.zoom,this.lastTouchCenter=this.getTouchCenter(e.touches)},doPinchZoom(e){const t=this.getTouchDistance(e.touches),s=this.getTouchCenter(e.touches),i=t/this.touchStartDistance,n=Math.max(this.minZoom,Math.min(this.maxZoom,this.touchStartZoom*i));if(n!==this.zoom){const e=this.elements.gridSvg.getBoundingClientRect(),t=s.x-e.left,i=s.y-e.top,o=this.viewBox.width/this.zoom,a=this.viewBox.height/this.zoom,l=this.viewBox.x+t/e.width*o,r=this.viewBox.y+i/e.height*a;this.zoom=n;const c=this.viewBox.width/this.zoom,d=this.viewBox.height/this.zoom;this.viewBox.x=l-t/e.width*c,this.viewBox.y=r-i/e.height*d,this.updateViewBox(),this.updateZoomDisplay()}const o=s.x-this.lastTouchCenter.x,a=s.y-this.lastTouchCenter.y,l=this.viewBox.width/this.zoom/this.elements.gridSvg.getBoundingClientRect().width;this.viewBox.x-=o*l,this.viewBox.y-=a*l,this.lastTouchCenter=s,this.updateViewBox()},adjustZoom(e){if(Math.max(this.minZoom,Math.min(this.maxZoom,this.zoom*e))!==this.zoom){const t=this.elements.gridSvg.getBoundingClientRect();this.zoomAtPoint(e,t.left+t.width/2,t.top+t.height/2)}},zoomAtPoint(e,t,s){const i=Math.max(this.minZoom,Math.min(this.maxZoom,this.zoom*e));if(i===this.zoom)return;const n=this.elements.gridSvg.getBoundingClientRect(),o=t-n.left,a=s-n.top,l=this.viewBox.width/this.zoom,r=this.viewBox.height/this.zoom,c=this.viewBox.x+o/n.width*l,d=this.viewBox.y+a/n.height*r;this.zoom=i;const u=this.viewBox.width/this.zoom,h=this.viewBox.height/this.zoom;this.viewBox.x=c-o/n.width*u,this.viewBox.y=d-a/n.height*h,this.updateViewBox(),this.hideMenu()},renderGrid(){const e=this.elements.gridContainer;e.innerHTML="";const t="space"===Game.state.currentView,s=t?Game.state.spaceGrid:Game.state.grid,i=t?Game.state.spaceGridBounds:Game.state.gridBounds,n=this.getExpandableTilesForView(),o=i.minX-1,a=i.maxX+1,l=i.minY-1,r=i.maxY+1,c=this.tileSize,d=this.tileGap;for(let i=l;i<=r;i++)for(let l=o;l<=a;l++){const o=`${l},${i}`,a=s[o],r=l*(c+d)+20,u=i*(c+d)+20;if(a&&a.owned){const s=this.createSvgTile(o,r,u,a,t);e.appendChild(s)}else if(n.has(o)){const s=this.createExpandableTile(o,r,u,t);e.appendChild(s)}}},getExpandableTilesForView(){const e="space"===Game.state.currentView?Game.state.spaceGrid:Game.state.grid,t=new Set;for(const[s,i]of Object.entries(e)){if(!i.owned)continue;const[n,o]=s.split(",").map(Number),a=[[0,-1],[0,1],[-1,0],[1,0]];for(const[s,i]of a){const a=`${n+s},${o+i}`,l=e[a];l&&l.owned||t.add(a)}}return t},createSvgTile(e,t,s,i,n=!1){const o="http://www.w3.org/2000/svg",a=this.tileSize,l=document.createElementNS(o,"g");if(l.classList.add("svg-tile"),l.dataset.coords=e,n&&l.classList.add("tile-space"),i.building)if("missileSilo"===i.building)l.classList.add("tile-silo");else{const t=BUILDINGS[i.building];if(t&&(l.classList.add(`tile-building-${t.category.toLowerCase()}`),"producer"===t.type)){Game.getBeaconMultiplier(e)>1&&l.classList.add("tile-beacon-affected")}}else l.classList.add("tile-empty");this.selectedTile===e&&l.classList.add("selected");const r=document.createElementNS(o,"rect");r.classList.add("tile-base"),r.setAttribute("x",t),r.setAttribute("y",s),r.setAttribute("width",a),r.setAttribute("height",a),r.setAttribute("rx",6),l.appendChild(r);const c=document.createElementNS(o,"path");c.classList.add("tile-bevel-light"),c.setAttribute("d",`\n            M ${t+6} ${s}\n            L ${t+a-6} ${s}\n            Q ${t+a} ${s} ${t+a} ${s+6}\n            L ${t+a-4} ${s+4+3}\n            L ${t+4+3} ${s+4+3}\n            L ${t+4+3} ${s+a-4-3}\n            L ${t} ${s+a-6}\n            Q ${t} ${s} ${t+6} ${s}\n        `),c.setAttribute("fill","rgba(255, 255, 255, 0.15)"),c.setAttribute("pointer-events","none"),l.appendChild(c);const d=document.createElementNS(o,"path");if(d.classList.add("tile-bevel-dark"),d.setAttribute("d",`\n            M ${t+a} ${s+6}\n            L ${t+a} ${s+a-6}\n            Q ${t+a} ${s+a} ${t+a-6} ${s+a}\n            L ${t+6} ${s+a}\n            Q ${t} ${s+a} ${t} ${s+a-6}\n            L ${t+4+3} ${s+a-4-3}\n            L ${t+a-4-3} ${s+a-4-3}\n            L ${t+a-4-3} ${s+4+3}\n            L ${t+a} ${s+6}\n        `),d.setAttribute("fill","rgba(0, 0, 0, 0.25)"),d.setAttribute("pointer-events","none"),l.appendChild(d),i.building){if("missileSilo"===i.building){const e=document.createElementNS(o,"text");e.setAttribute("x",t+a/2),e.setAttribute("y",s+a/2+8),e.setAttribute("text-anchor","middle"),e.setAttribute("font-size","24"),e.textContent="üöÄ",l.appendChild(e)}else{const e=BUILDINGS[i.building];if(e){const i=document.createElementNS(o,"text");i.setAttribute("x",t+a/2),i.setAttribute("y",s+a/2+8),i.setAttribute("text-anchor","middle"),i.setAttribute("font-size","24"),i.textContent=e.icon,l.appendChild(i)}}const n=Game.getTileBlessing(e);if(n&&n.buildingId===i.building){l.classList.add("tile-blessed-active");const e=document.createElementNS(o,"text");e.setAttribute("x",t+a-8),e.setAttribute("y",s+a-6),e.setAttribute("text-anchor","end"),e.setAttribute("font-size","12"),e.setAttribute("font-weight","bold"),e.setAttribute("fill","#f0abfc"),e.textContent="3x",l.appendChild(e)}}else{const i=Game.getTileBlessing(e);if(i){l.classList.add("tile-blessed");const e=BUILDINGS[i.buildingId];if(e){const i=document.createElementNS(o,"text");i.setAttribute("x",t+a/2),i.setAttribute("y",s+a/2+3),i.setAttribute("text-anchor","middle"),i.setAttribute("font-size","14"),i.setAttribute("fill","#f0abfc"),i.textContent=e.icon,l.appendChild(i);const n=document.createElementNS(o,"text");n.setAttribute("x",t+a/2),n.setAttribute("y",s+a/2+18),n.setAttribute("text-anchor","middle"),n.setAttribute("font-size","10"),n.setAttribute("fill","#f0abfc"),n.textContent="3x",l.appendChild(n)}}}return l.addEventListener("click",t=>{t.stopPropagation(),this.onTileClick(e,t)}),l},createExpandableTile(e,t,s,i=!1){const n="http://www.w3.org/2000/svg",o=this.tileSize,a=document.createElementNS(n,"g");a.classList.add("svg-tile","tile-expandable"),a.dataset.coords=e,i&&a.classList.add("tile-space");const l=document.createElementNS(n,"rect");l.classList.add("tile-base"),l.setAttribute("x",t),l.setAttribute("y",s),l.setAttribute("width",o),l.setAttribute("height",o),l.setAttribute("rx",6),a.appendChild(l);const r=document.createElementNS(n,"text");return r.setAttribute("x",t+o/2),r.setAttribute("y",s+o/2+8),r.setAttribute("text-anchor","middle"),r.setAttribute("font-size","24"),r.setAttribute("fill","#5a9e4b"),r.textContent="+",a.appendChild(r),a.addEventListener("click",t=>{t.stopPropagation(),this.onExpandableTileClick(e,t)}),a},onTileClick(e,t){if(Game.state.grid[e].building)return this.elements.buildingMenu.classList.add("hidden"),this.menuTargetTile=null,this.menuType=null,void(this.selectedTile===e?(document.querySelectorAll(".svg-tile.selected").forEach(e=>e.classList.remove("selected")),this.selectedTile=null,this.updateTileInfo(null)):this.selectTile(e));this.menuTargetTile===e&&"build"===this.menuType?this.hideMenu():(this.selectTile(e),this.showBuildMenu(e,t.clientX,t.clientY))},onExpandableTileClick(e,t){this.menuTargetTile===e&&"expand"===this.menuType?this.hideMenu():this.showExpandMenu(e,t.clientX,t.clientY)},selectTile(e){if(document.querySelectorAll(".svg-tile.selected").forEach(e=>e.classList.remove("selected")),this.selectedTile===e)this.selectedTile=null,this.updateTileInfo(null);else{this.selectedTile=e;const t=document.querySelector(`.svg-tile[data-coords="${e}"]`);t&&t.classList.add("selected"),this.updateTileInfo(e)}},getBuildingUnlockStatus(e){const t=[];for(const s of Object.keys(e.costs)){const e=Game.state.resources[s]>0,i=Game.productionRates[s]>0;"food"!==s&&(e||i||t.push(s))}return{unlocked:0===t.length,missingResources:t}},isBuildingUnlocked(e){return this.getBuildingUnlockStatus(e).unlocked},showBuildMenu(e,t,s){this.menuTargetTile=e,this.menuType="build";const i=Game.getTileBlessing(e);this.menuBlessedBuildingId=i?i.buildingId:null;const n=this.elements.buildingMenuContent;n.innerHTML="",this.elements.buildingMenu.classList.remove("tile-menu");for(const t of this.allBuildingCategories){if(!isCategoryUnlocked(t,Game.prestige.skills))continue;const s=getBuildingsByCategory(t);if(0===s.length)continue;const i=document.createElement("div");i.className="menu-category";const o=document.createElement("div");o.className="menu-category-header",o.textContent=t,i.appendChild(o);let a=!1;for(const t of s){const s=this.createBuildingOption(t,e);s&&(i.appendChild(s),a=!0)}a&&n.appendChild(i)}this.positionMenu(t,s),this.elements.buildingMenu.classList.remove("hidden")},showExpandMenu(e,t,s){this.menuTargetTile=e,this.menuType="expand";const i=this.elements.buildingMenuContent;i.innerHTML="",this.elements.buildingMenu.classList.add("tile-menu");const n=document.createElement("div");n.className="menu-category";const o=document.createElement("div");o.className="menu-category-header",o.textContent="Purchase Tile",n.appendChild(o);const a=getBuildingsByCategory("Tiles");for(const e of a){const t=this.createBuildingOption(e);n.appendChild(t)}i.appendChild(n),this.positionMenu(t,s),this.elements.buildingMenu.classList.remove("hidden")},getBuildingEffectText(e,t=null){const s=RESOURCE_ICONS[e.produces]||RESOURCE_ICONS[e.multiplies]||"";if("producer"===e.type){const i=Game.productionRates[e.produces]||0,n=t?Game.getBlessingMultiplier(t,e.id):1,o=i+Game.calculateBuildingProduction(e,1)*n,a=n>1?` (${n}x blessed)`:"";return`${Game.formatNumberDecimal(i)}/s ‚Üí ${Game.formatNumberDecimal(o)}/s ${s}${a}`}if("multiplier"===e.type){const i=e.multiplies,n=Game.productionRates[i]||0,o=e.multiplierBonus||1,a=t?Game.getBlessingMultiplier(t,e.id):1,l=o*a,r=(Game.calculateGlobalMultipliers()[i],1+(Game.state.buildingCounts[e.id]||0)*o),c=n*((r+l)/r),d=a>1?` (${a}x blessed)`:"";return`${Game.formatNumberDecimal(n)}/s ‚Üí ${Game.formatNumberDecimal(c)}/s ${s}${d}`}if("beacon"===e.type){const t=Game.getResearchBeaconBonus?Game.getResearchBeaconBonus():0;return`${e.beaconMultiplier+t}x adjacent tiles`}return"tile"===e.type?"+1 tile":e.effect},createBuildingOption(e,t=null){const s=this.getBuildingUnlockStatus(e);if(s.missingResources.length>=2)return null;const i=document.createElement("div");i.className="building-option",i.dataset.buildingId=e.id;this.menuBlessedBuildingId===e.id&&i.classList.add("blessed-building");const n=s.unlocked;if(!n){i.classList.add("locked-building");const e=document.createElement("div");e.className="building-option-icon",e.textContent="üîí",i.appendChild(e);const t=document.createElement("div");t.className="building-option-info";const n=document.createElement("div");n.className="building-option-effect locked-requirement";const o=s.missingResources[0],a=RESOURCE_ICONS[o]||o;return n.innerHTML=`Requires ${a}`,t.appendChild(n),i.appendChild(t),i}Game.canAfford(e.id)?i.classList.add("affordable"):i.classList.add("unaffordable");const o=Game.getBuildingCost(e.id),a="tile"===e.type?Game.state.tilePurchases[e.id]||0:Game.state.buildingCounts[e.id]||0,l=document.createElement("div");l.className="building-option-icon",l.textContent="tile"===e.type?"üü©":e.icon,i.appendChild(l);const r=document.createElement("div");r.className="building-option-info";const c=document.createElement("div");c.className="building-option-name",c.textContent=e.name,r.appendChild(c);const d=document.createElement("div");d.className="building-option-effect",d.textContent=this.getBuildingEffectText(e,t),r.appendChild(d);const u=document.createElement("div");u.className="building-option-costs";for(const[e,t]of Object.entries(o)){const s=document.createElement("div");s.className="cost-bar",s.dataset.resource=e,s.dataset.cost=t;const i=Game.state.resources[e],n=Math.min(1,i/t),o=i>=t;s.classList.add(o?"affordable":"unaffordable");const a=document.createElement("div");a.className="cost-bar-fill",a.style.width=100*n+"%",s.appendChild(a);const l=document.createElement("span");l.className="cost-bar-label",l.innerHTML=`${RESOURCE_ICONS[e]} ${Game.formatNumber(t)}`,s.appendChild(l),u.appendChild(s)}if(r.appendChild(u),i.appendChild(r),a>0){const e=document.createElement("div");e.className="building-option-count",e.textContent=a,i.appendChild(e)}return n&&i.addEventListener("click",()=>{Game.canAfford(e.id)&&this.onBuildingOptionClick(e.id)}),i},onBuildingOptionClick(e){const t=BUILDINGS[e],s=this.menuTargetTile;"build"===this.menuType?Game.placeBuilding(s,e)&&(this.renderGrid(),this.hideMenu(),this.updateTileInfo(s),this.showNotification(`Built ${t.name}!`)):"expand"===this.menuType&&Game.purchaseTile(s,e)&&(this.renderGrid(),this.hideMenu(),this.showNotification("Tile purchased!"))},positionMenu(e,t){const s=this.elements.buildingMenu;s.classList.remove("hidden"),s.style.left="50%",s.style.top="50%",s.style.transform="translate(-50%, -50%)"},hideMenu(){this.elements.buildingMenu.classList.add("hidden"),this.menuTargetTile=null,this.menuType=null,this.selectedTile=null,document.querySelectorAll(".svg-tile.selected").forEach(e=>e.classList.remove("selected")),this.updateTileInfo(null)},updateTileInfo(e){const t=this.elements.tileInfo;if(!e)return void(t.innerHTML="<span>Click a tile to build</span>");const s=Game.state.grid[e];if(s)if(s.building){const i=BUILDINGS[s.building];let n=`<span>${i.icon} <strong>${i.name}</strong></span>`;if(n+=`<span> | ${this.getBuildingInfoText(i)}</span>`,"producer"===i.type){const t=Game.getBeaconMultiplier(e);t>1&&(n+=`<span> | Beacon bonus: ${t.toFixed(1)}x</span>`)}const o=Game.getTileBlessing(e);o&&o.buildingId===s.building&&(n+=`<span> | Blessed: ${o.multiplier}x</span>`),t.innerHTML=n}else{const s=Game.getTileBlessing(e);if(s){const e=BUILDINGS[s.buildingId];t.innerHTML=`<span>Blessed for ${e.icon} ${e.name} (${s.multiplier}x)</span>`}else t.innerHTML=`<span>Empty tile at (${e})</span>`}else t.innerHTML="<span>Click a tile to build</span>"},getBuildingInfoText(e){if("multiplier"===e.type){const t=Game.state.buildingCounts[e.id]||0,s=e.multiplierBonus||1;return`${1+t*s}x ${RESOURCE_ICONS[e.multiplies]||""} multiplier (+${s}x each)`}if("producer"===e.type){const t=Game.calculateBuildingProduction(e,1),s=RESOURCE_ICONS[e.produces]||"";return`Produces ${Game.formatNumber(t)}/s ${s}`}if("beacon"===e.type){const t=Game.getResearchBeaconBonus?Game.getResearchBeaconBonus():0;return`${e.beaconMultiplier+t}x to adjacent producers`}return e.effect},updateResourceDisplay(){for(const e of["food","wood","stone","metal","research","mana"]){const t=this.elements.resources[e];t.rate.textContent=`(${Game.formatRate(Game.productionRates[e])}/s)`;const s=Game.state.resources[e]||0,i=Game.productionRates[e]||0,n=0===s&&0===i;t.container.style.display=n?"none":""}this.elements.buildingMenu.classList.contains("hidden")||document.querySelectorAll(".building-option").forEach(e=>{const t=e.dataset.buildingId,s=BUILDINGS[t],i=this.getBuildingUnlockStatus(s).unlocked&&Game.canAfford(t);e.classList.remove("affordable","unaffordable"),i?e.classList.add("affordable"):e.classList.add("unaffordable");e.querySelectorAll(".cost-bar").forEach(e=>{const t=e.dataset.resource,s=parseFloat(e.dataset.cost),i=Game.state.resources[t],n=Math.min(1,i/s),o=i>=s;e.classList.toggle("affordable",o),e.classList.toggle("unaffordable",!o);const a=e.querySelector(".cost-bar-fill");a&&(a.style.width=100*n+"%")})}),Game.isManaUnlocked()&&this.updateSpellStates(),Game.isResearchUnlocked()&&this.updateResearchStates(),Game.isSpaceResearchUnlocked()&&this.updateSpacePhase()},showNotification(e,t="success"){console.log(`[${t}] ${e}`)},updateSkillPointDisplay(){const e=Game.prestige.skillPoints,t=Game.prestige.pendingSkillPoints,s=Game.getSkillPointProgress();this.elements.skillPointsAvailable.textContent=e,this.elements.skillPointsPending.textContent=t>0?`+${t} pending`:"",this.elements.skillPointsPending.classList.toggle("hidden",0===t),this.elements.skillProgressBar.style.width=100*s+"%";const i=Game.getNextSkillPointThreshold()-Game.prestige.lifetimeResources,n=Object.values(Game.productionRates).reduce((e,t)=>e+t,0);if(n>0&&i>0){const e=Math.ceil(i/n);this.elements.skillPointTimer.textContent=this.formatTime(e)}else this.elements.skillPointTimer.textContent=i<=0?"Ready!":"--:--";this.elements.btnPrestige.classList.toggle("has-pending",t>0),this.elements.skillPanel.classList.contains("hidden")||(this.elements.panelSkillPoints.textContent=e,this.updateSkillItems())},formatTime(e){if(e<60)return`${e}s`;if(e<3600){return`${Math.floor(e/60)}m ${e%60}s`}if(e<86400){return`${Math.floor(e/3600)}h ${Math.floor(e%3600/60)}m`}return`${Math.floor(e/86400)}d ${Math.floor(e%86400/3600)}h`},showSkillPanel(){this.elements.skillPanelOverlay.classList.remove("hidden"),this.elements.skillPanel.classList.remove("hidden"),this.renderSkillPanel()},hideSkillPanel(){this.elements.skillPanelOverlay.classList.add("hidden"),this.elements.skillPanel.classList.add("hidden")},showPrestigeModal(){const e=Game.prestige.pendingSkillPoints,t=document.getElementById("prestige-overlay"),s=document.getElementById("prestige-modal"),i=document.getElementById("prestige-pending-text"),n=document.getElementById("prestige-pending-count"),o=document.getElementById("prestige-warning");n.textContent=e,e>0?(i.classList.remove("hidden"),o.classList.add("hidden")):(i.classList.add("hidden"),o.classList.remove("hidden"));const a=Game.prestige.lifetimeResources,l=Game.prestige.skillPoints+e;let r=0;if(window.SKILLS&&window.getSkillCost)for(const[e,t]of Object.entries(Game.prestige.skills))if(t&&t>0&&SKILLS[e])for(let s=0;s<t;s++)r+=getSkillCost(e,s);const c=l+r,d=Game.getNextSkillPointThreshold(),u=Game.calculateTotalSkillPoints(a);let h=0;if(u>0){let e=1e3;for(;Game.calculateTotalSkillPoints(e)<u;)e*=2;let t=0,s=e;for(;s-t>1;){const e=Math.floor((t+s)/2);Game.calculateTotalSkillPoints(e)>=u?s=e:t=e}h=s}document.getElementById("prestige-lifetime-resources").textContent=Game.formatNumber(a),document.getElementById("prestige-total-sp").textContent=c,document.getElementById("prestige-sp-progress").textContent=`${Game.formatNumber(a)} / ${Game.formatNumber(d)}`,t.classList.remove("hidden"),s.classList.remove("hidden")},hidePrestigeModal(){document.getElementById("prestige-overlay").classList.add("hidden"),document.getElementById("prestige-modal").classList.add("hidden")},showSPTutorial(){document.getElementById("sp-tutorial-overlay").classList.remove("hidden"),document.getElementById("sp-tutorial").classList.remove("hidden")},hideSPTutorial(){document.getElementById("sp-tutorial-overlay").classList.add("hidden"),document.getElementById("sp-tutorial").classList.add("hidden")},renderSkillPanel(){const e=this.elements.skillPanelContent;e.innerHTML="",this.elements.panelSkillPoints.textContent=Game.prestige.skillPoints;const t=document.createElement("div");t.className="skill-tree";const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttribute("class","skill-tree-lines"),t.appendChild(s);const i=document.createElement("div");i.className="skill-tree-nodes";const n=getSkillTree(),o=Object.keys(n).sort((e,t)=>parseInt(e)-parseInt(t));for(const e of o){const t=n[e],s=document.createElement("div");s.className="skill-tree-row";for(const e of t){const t=this.createSkillNode(e);t.dataset.skillId=e.id,s.appendChild(t)}i.appendChild(s)}t.appendChild(i),e.appendChild(t),requestAnimationFrame(()=>this.drawSkillConnections(s,i))},drawSkillConnections(e,t){e.innerHTML="";const s=t.getBoundingClientRect();e.setAttribute("width",s.width),e.setAttribute("height",s.height);for(const[i,n]of Object.entries(SKILLS)){if(0===n.requires.length)continue;const o=t.querySelector(`[data-skill-id="${i}"]`);if(!o)continue;const a=o.getBoundingClientRect(),l=a.left-s.left+a.width/2,r=a.top-s.top+a.height/2;for(const o of n.requires){const n=t.querySelector(`[data-skill-id="${o}"]`);if(!n)continue;const a=n.getBoundingClientRect(),c=a.left-s.left+a.width/2,d=a.top-s.top+a.height/2,u=l-c,h=r-d,m=Math.sqrt(u*u+h*h);if(0===m)continue;const p=u/m,g=h/m,f=c+40*p,S=d+40*g,b=l-40*p,w=r-40*g,L=document.createElementNS("http://www.w3.org/2000/svg","line");L.setAttribute("x1",f),L.setAttribute("y1",S),L.setAttribute("x2",b),L.setAttribute("y2",w);const B=Game.prestige.skills[o]||0,v=Game.prestige.skills[i]||0;B>0&&v>0?L.classList.add("line-purchased"):B>0?L.classList.add("line-available"):L.classList.add("line-locked"),e.appendChild(L)}}},createSkillNode(e){const t=Game.prestige.skills[e.id]||0,s=null!==e.maxLevel&&t>=e.maxLevel,i=isSkillLocked(e.id,Game.prestige.skills),n=window.getSkillCost?getSkillCost(e.id,t):e.baseCost,o=!s&&!i&&Game.prestige.skillPoints>=n,a=document.createElement("div");a.className="skill-node",a.dataset.skillId=e.id,s?a.classList.add("maxed"):t>0?(a.classList.add("has-levels"),o&&a.classList.add("can-purchase")):i?a.classList.add("locked"):o?a.classList.add("can-purchase"):a.classList.add("available");const l=document.createElement("div");if(l.className="skill-node-icon",l.textContent=i?"?":e.icon,a.appendChild(l),!i&&null!==e.maxLevel&&(e.maxLevel>1||s)){const s=document.createElement("div");s.className="skill-node-level",s.textContent=`${t}/${e.maxLevel}`,a.appendChild(s)}const r=document.createElement("div");r.className="skill-node-tooltip";const c=document.createElement("div");c.className="skill-tooltip-name",c.textContent=i?"???":e.name,r.appendChild(c);const d=document.createElement("div");if(d.className="skill-tooltip-desc",d.textContent=i?"Unlock prerequisite skills first":e.description,r.appendChild(d),!i){if(null!==e.maxLevel&&(e.maxLevel>1||s)){const s=document.createElement("div");s.className="skill-tooltip-level",s.textContent=`Level: ${t} / ${e.maxLevel}`,r.appendChild(s)}const i=document.createElement("div");i.className="skill-tooltip-cost",s?(i.textContent="MAX",i.classList.add("maxed")):(i.textContent=`Cost: ${n} SP`,o||i.classList.add("unaffordable")),r.appendChild(i)}return a.appendChild(r),s||i||a.addEventListener("click",()=>{Game.purchaseSkill(e.id)&&(this.renderSkillPanel(),this.updateSkillPointDisplay(),this.updateSpellContainer(),this.updateResearchContainer())}),a},updateSkillItems(){document.querySelectorAll(".skill-node").forEach(e=>{const t=e.dataset.skillId,s=SKILLS[t];if(!s)return;const i=Game.prestige.skills[t]||0,n=null!==s.maxLevel&&i>=s.maxLevel,o=isSkillLocked(t,Game.prestige.skills),a=window.getSkillCost?getSkillCost(t,i):s.baseCost,l=!n&&!o&&Game.prestige.skillPoints>=a;e.classList.remove("maxed","has-levels","locked","can-purchase","available"),n?e.classList.add("maxed"):i>0?(e.classList.add("has-levels"),l&&e.classList.add("can-purchase")):o?e.classList.add("locked"):l?e.classList.add("can-purchase"):e.classList.add("available")})},updateSpellContainer(){const e=this.elements.spellContainer;e&&(Game.isManaUnlocked()?(e.classList.remove("hidden"),this.updateSpellStates()):e.classList.add("hidden"))},updateSpellStates(){const e=Game.state.resources.mana,t=this.elements.spellTimeWarp,s=document.getElementById("time-warp-preview"),i=document.getElementById("time-warp-desc"),n=Game.getTimeWarpCurrentCost();i&&(i.textContent=`Skip 1s per ${n} mana`);const o=Game.getTimeWarpPreview();s&&(s.textContent=o>0?`Skip ${this.formatTime(o)}`:"Uses all mana"),e>=10?t.classList.remove("disabled"):t.classList.add("disabled");const a=this.elements.spellBlessTile,l=Game.getBlessTileCost(),r=Object.values(Game.state.grid).some(e=>e.owned&&!e.building),c=Object.values(Game.state.grid).some(e=>{if(!e.owned||!e.building)return!1;const t=BUILDINGS[e.building];return t&&"tile"!==t.type}),d=a.querySelector(".spell-cost");d&&(d.textContent=`${Game.formatNumber(l)} mana`),e>=l&&r&&c?a.classList.remove("disabled"):a.classList.add("disabled")},castSpell(e){let t;"timeWarp"===e?(t=Game.castTimeWarp(),t.success?(this.showNotification(`Time Warp! Skipped ${t.seconds} seconds.`),this.updateResourceDisplay(),this.updateSkillPointDisplay()):this.showNotification(t.message)):"blessTile"===e&&(t=Game.castBlessTile(),t.success?(this.showNotification(`Blessed tile ${t.tile} for ${t.buildingIcon} ${t.buildingName}!`),this.renderGrid(),this.updateResourceDisplay()):this.showNotification(t.message)),this.updateSpellStates()},updateResearchContainer(){const e=this.elements.researchContainer;e&&(Game.isResearchUnlocked()?(e.classList.remove("hidden"),this.renderResearchList()):e.classList.add("hidden"))},renderResearchList(){const e=this.elements.researchList;if(e&&window.RESEARCH){e.innerHTML="";for(const[t,s]of Object.entries(RESEARCH)){const t=this.createResearchItem(s);e.appendChild(t)}}},createResearchItem(e){const t=Game.getResearchLevel(e.id),s=null!==e.maxLevel&&t>=e.maxLevel,i=window.getResearchCost?getResearchCost(e.id,t):e.baseCost,n=Game.state.resources.research>=i,o=document.createElement("div");o.className="research-item",o.dataset.researchId=e.id,s?o.classList.add("maxed"):n||o.classList.add("disabled");const a=document.createElement("div");a.className="research-icon",a.textContent=e.icon,o.appendChild(a);const l=document.createElement("div");l.className="research-info";const r=document.createElement("div");r.className="research-name",r.innerHTML=`<span>${e.name}</span>`;const c=document.createElement("span");c.className="research-level",s?(c.classList.add("maxed"),c.textContent="MAX"):1===e.maxLevel?c.textContent=t>0?"Purchased":"":c.textContent=`Lv.${t}`,r.appendChild(c),l.appendChild(r);const d=document.createElement("div");if(d.className="research-effect",d.textContent=this.getResearchEffectText(e,t),l.appendChild(d),s){const e=document.createElement("div");e.className="research-cost maxed",e.textContent="Complete",l.appendChild(e)}else{const e=document.createElement("div");e.className="research-cost",n&&e.classList.add("affordable"),e.textContent=`Cost: ${Game.formatNumber(i)} research`,l.appendChild(e)}return o.appendChild(l),s||o.addEventListener("click",()=>{Game.purchaseResearch(e.id)&&(this.showNotification(`Researched ${e.name}!`),this.renderResearchList(),this.updateResourceDisplay(),"spaceProgram"===e.id&&this.updateSpaceContainer())}),o},getResearchEffectText(e,t){if("productionMultiplier"===e.effectType){const s=1+e.effectPerLevel*t,i=1+e.effectPerLevel*(t+1);return null!==e.maxLevel&&t>=e.maxLevel?`${s.toFixed(1)}x ${e.resource} production`:`${s.toFixed(1)}x ‚Üí ${i.toFixed(1)}x ${e.resource} production`}if("beaconBonus"===e.effectType){const s=e.effectPerLevel*t,i=e.effectPerLevel*(t+1);return null!==e.maxLevel&&t>=e.maxLevel?`+${s.toFixed(1)} beacon multiplier`:`+${s.toFixed(1)} ‚Üí +${i.toFixed(1)} beacon multiplier`}return"unlock"===e.effectType?t>0?`${e.unlocks} unlocked!`:`Unlocks ${e.unlocks}`:e.description},updateResearchStates(){Game.isResearchUnlocked()&&window.RESEARCH&&document.querySelectorAll(".research-item").forEach(e=>{const t=e.dataset.researchId,s=RESEARCH[t];if(!s)return;const i=Game.getResearchLevel(t),n=null!==s.maxLevel&&i>=s.maxLevel,o=window.getResearchCost?getResearchCost(t,i):s.baseCost,a=Game.state.resources.research>=o;e.classList.remove("disabled","maxed"),n?e.classList.add("maxed"):a||e.classList.add("disabled");const l=e.querySelector(".research-cost");l&&!n&&(l.classList.toggle("affordable",a),l.textContent=`Cost: ${Game.formatNumber(o)} research`)})},updateSpaceContainer(){const e=this.elements.spaceContainer;e&&(Game.isSpaceResearchUnlocked()?(e.classList.remove("hidden"),this.updateSpacePhase()):e.classList.add("hidden"))},updateSpacePhase(){const{spacePhaseSilo:e,spacePhaseLaunch:t,spacePhaseTabs:s}=this.elements;e&&t&&s&&(e.classList.add("hidden"),t.classList.add("hidden"),s.classList.add("hidden"),Game.state.hasLaunchedRocket?(s.classList.remove("hidden"),this.updateViewTabs()):Game.state.hasMissileSilo?(t.classList.remove("hidden"),this.updateLaunchButton()):(e.classList.remove("hidden"),this.updateSiloButton()))},updateSiloButton(){const e=this.elements.btnBuildSilo;if(!e)return;const t=Game.canBuildMissileSilo();e.disabled=!t.can;const s=document.querySelector("#space-phase-silo .space-phase-requirements span");s&&(!t.can&&t.reason?s.textContent=t.reason:s.textContent="Requires: 100M each resource + 4 empty adjacent tiles (2x2)")},updateLaunchButton(){const e=this.elements.btnLaunchRocket;if(!e)return;const t=Game.canLaunchRocket();e.disabled=!t.can;const s=document.querySelector("#space-phase-launch .space-phase-requirements span");s&&(!t.can&&t.reason?s.textContent=t.reason:s.textContent="Requires: 250M each resource")},updateViewTabs(){const{btnViewEarth:e,btnViewSpace:t,currentViewName:s}=this.elements;if(!e||!t)return;const i=Game.state.currentView;e.classList.toggle("active","earth"===i),t.classList.toggle("active","space"===i),s&&(s.textContent="space"===i?"Space":"Earth"),document.body.classList.toggle("space-view","space"===i)},buildMissileSilo(){const e=Game.buildMissileSilo();e.success?(this.showNotification("Missile Silo built! Prepare for launch."),this.renderGrid(),this.updateSpaceContainer()):this.showNotification(e.message)},launchRocket(){const e=Game.launchRocket();e.success?(this.showNotification("Rocket launched! Welcome to space."),this.updateSpaceContainer()):this.showNotification(e.message)},switchView(e){Game.setCurrentView(e),this.updateViewTabs(),this.renderGrid(),this.centerGrid(),this.hideMenu()}};document.addEventListener("DOMContentLoaded",()=>{Game.init(),UI.init()}),window.UI=UI;